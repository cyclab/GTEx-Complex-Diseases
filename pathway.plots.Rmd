---
title: "Plots for pathway analysis"
author: "Chi-Lam Poon"
date: "9/23/2019"
output: html_document
---



## Visualize results from GSEA
### Dot plots for DO and HPO and hallmark
```{R}
# load reports
result.dir <- '~/cvd/v6/gsea/map.result'
brains <- c('brain_0', 'brain_1', 'brain_2')
reports <- c('do', 'hpo', 'hallmark', 'gobp')


for (brain in brains) {
  for (r in reports) {
    assign(paste0(brain, '.', r, '.', 'pos'), read.delim(file.path(result.dir, paste0(brain, '/', r, '.pos.txt'))))
    assign(paste0(brain, '.', r, '.', 'neg'), read.delim(file.path(result.dir, paste0(brain, '/', r, '.neg.txt'))))
  }
}


comb.res <- function(thres, report, dir) {
  for (t in 1:length(brains)) {
    tmp <- get(paste0(brains[t], '.', report, '.', dir))
    tmp <- tmp[tmp$FDR.q.val < thres, ]
    assign(paste0('f', t-1), tmp <- tmp[tmp$FDR.q.val < thres, ])
  }
  itsc <- data.frame(name=intersect(intersect(f0$NAME, f1$NAME), f2$NAME))
  itsc$fdr0 <- sapply(as.character(itsc$name), function(x) f0[f0$NAME==x,]$FDR.q.val)
  itsc$fdr1 <- sapply(as.character(itsc$name), function(x) f1[f1$NAME==x,]$FDR.q.val)
  itsc$fdr2 <- sapply(as.character(itsc$name), function(x) f2[f2$NAME==x,]$FDR.q.val)
  itsc$nes0 <- sapply(as.character(itsc$name), function(x) f0[f0$NAME==x,]$NES)
  itsc$nes1 <- sapply(as.character(itsc$name), function(x) f1[f1$NAME==x,]$NES)
  itsc$nes2 <- sapply(as.character(itsc$name), function(x) f2[f2$NAME==x,]$NES)
  # process term names
  itsc$name <- tolower(itsc$name)
  itsc$name <- gsub(paste0('^', report, '_'), '', itsc$name)
  itsc$name <- gsub('_', ' ', itsc$name)
  # sort by brian1 nes
  itsc <- itsc[order(abs(itsc$nes1), decreasing=T),]
  itsc$name <- factor(itsc$name)
  rownames(itsc) <- 1:nrow(itsc)
  itsc
}

hm.itsc.pos <- comb.res(0.25, 'hallmark', 'pos')
hm.itsc.neg <- comb.res(1, 'hallmark', 'neg')
hm.itsc.neg <- hm.itsc.neg[-5,]

# replace words
hm.itsc.pos$name <- gsub('pi3k akt mtor', 'PI3K/AKT/mTOR', hm.itsc.pos$name)
hm.itsc.pos$name <- gsub('il6 jak stat3', 'IL-6/JAK/STAT3', hm.itsc.pos$name)
hm.itsc.pos$name <- gsub('kras', 'KRAS', hm.itsc.pos$name)
hm.itsc.pos$name <- gsub('mtorc1', 'mTORC1', hm.itsc.pos$name)
hm.itsc.pos$name <- gsub('tnfa signaling via nfkb', 'TNFA signaling via NF-kB', hm.itsc.pos$name)

hm.itsc.neg$name <- gsub('kras', 'KRAS', hm.itsc.neg$name)
hm.itsc.neg$name <- gsub('dn', 'down', hm.itsc.neg$name)


candies <- function(file, dir) {
  library(tidyr)
  library(colorspace)
  library(ggplot2)
  
  if (!dir %in% c('pos', 'neg')) stop('dir should be pos or neg only.')
  
  long <- gather(file, variable, value, fdr0:nes2)
  long$tissue <- gsub('^...', 'brain-', long$variable)
  long$variable <- gsub('[0-9+]$', '', long$variable)
  plot.df <- spread(long, key=variable, value=value)
  
  if (dir == 'pos') {
    g <- ggplot(plot.df, aes(x = tissue, y = name, size = nes)) +
      geom_point(aes(fill=fdr), colour="black", pch=21) +
      scale_fill_continuous_sequential(palette = "Sunset", rev=F, name="FDR", begin=0.2, guide = guide_colorbar(order = 1)) +
      scale_y_discrete(limits = rev(unique(plot.df$name))) + 
      theme_bw() + labs(x="", y="", size="NES") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  } else {
    g <- ggplot(plot.df, aes(x = tissue, y = name, size = nes)) +
      geom_point(aes(fill=fdr), colour="black", pch=21) +
      scale_fill_continuous_sequential(palette = "TealGrn", rev=F, name="FDR", begin=0.2, guide = guide_colorbar(order = 1)) +
      scale_y_discrete(limits = rev(unique(plot.df$name))) + 
      theme_bw() + labs(x="", y="", size="NES") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
  }
  g
}

candies(hm.itsc.pos, 'pos')
```


#### negative results
```{R, fig.height=6}
candies(hm.itsc.neg, 'neg')
```


## DO & HPO
Use forms to show the results...
```{R, eval=F}
do.all.pos <- comb.res(1.1, 'do', 'pos')
do.all.neg <- comb.res(1.1, 'do', 'neg')

hpo.all.pos <- comb.res(1.1, 'hpo', 'pos')
hpo.all.neg <- comb.res(1.1, 'hpo', 'neg')

# Select some terms



```


### Other tissues
```{R, eval=F}
# do it on macOS
result.dir <- '~/Downloads/map.result'

tissues <- c('brain_0', 'brain_1', 'brain_2',"adipose_visceral", "artery_tibial", "heart_atrial_appendage", "minor_salivary_gland", "muscle_skeletal", "pituitary", "skin")
reports <- c('do', 'hpo', 'hallmark', 'gobp')

for (tissue in tissues) {
  for (r in reports) {
    assign(paste0(tissue, '.', r, '.', 'pos'), read.delim(file.path(result.dir, paste0(tissue, '/', r, '.pos.txt'))))
    assign(paste0(tissue, '.', r, '.', 'neg'), read.delim(file.path(result.dir, paste0(tissue, '/', r, '.neg.txt'))))

  }
}

excel_dir <- '/Users/magicpants/GoogleDrive/cvd/results'
library(xlsx)
for (tissue in tissues) {
  for (r in reports) {
    for (d in c('pos', 'neg')) {
      if (paste0(tissue, '.', r, '.', d) == paste0(tissue, '.do.', 'pos')) {
        write.xlsx(get(paste0(tissue, '.do.', 'pos'))[,c(1:11)], file=file.path(excel_dir, paste0(tissue,".", "gsea.xlsx")), sheetName='do.pos', col.names=T, row.names=F, append=F)
      } else {
        write.xlsx(get(paste0(tissue, '.', r, '.', d))[,c(1:11)], file=file.path(excel_dir, paste0(tissue,".", "gsea.xlsx")), sheetName=paste0(r, '.', d), col.names=T, row.names=F, append=T)
      }
    }
  }
}


```




