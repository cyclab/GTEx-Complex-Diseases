---
title: "Analysis and plots of DEGs"
author: "Chi-Lam Poon"
date: "9/18/2019"
output: html_document
---

## Load files
```{R}
all <- list.files('~/cvd/v6/results/limma.tables', full.names = T)
all.de <- list()
for (a in all) {
  tmp <- read.table(a, header=T)
  if (nrow(tmp[tmp$adj.P.Val < 0.1 & abs(tmp$logFC) > log2(1.5),]) > 0) {
    name = gsub('/home/pclam/cvd/v6/results/limma.tables/', '', a)
    name = gsub('.tsv$', '', name)
    all.de[[name]] <- tmp[tmp$adj.P.Val < 0.1 & abs(tmp$logFC) > log2(1.5),]
  }
}


brains.df <- read.delim('~/cvd/v6/results/combined.brain.p.txt')
```


### DEGs in brian clusters
```{R, eval=F}
# the number of significant DEGs
nrow(brains.df[brains.df$fisherQ < 0.1,])
nrow(brains.df[brains.df$fisherQ < 0.05,])

# add directions
cols <- colnames(brains.df)[grepl('t', colnames(brains.df))]
add.dir <- function(n) {
  row <- brains.df[n,]
  dir <- c()
  for (c in cols) {
    ifelse(row[[c]] > 0, dir <- c(dir, '+'), dir <- c(dir, '-'))
  }
  paste(dir, collapse = ',')
}

brains.df$dir <- sapply(1:nrow(brains.df), add.dir)
table(brains.df$dir[1:220])
# -,-,- -,+,- +,-,- +,-,+ +,+,+ 
#    92     1     1     1   125 

colnames(brains.df) <- c('ESID', 'symbol', 'brain0.t', 'brain0.adj.p', 'brain1.t', 'brain1.adj.p', 'brain2.t', 'brain2.adj.p', 'combined.adj.p', 'direction')

write.table(brains.df, file='~/cvd/v6/results/combined.brain.p.txt', col.names = T, row.names = F, quote = F, sep = '\t')
```

### Intersection with hypoxia

```{R}
# significant DEG
deg <- as.character(brains.df[brains.df$combined.adj.p < 0.1,]$symbol)
# hypoxia gene list
hxg <- read.delim('~/cvd/v6/data/hypoxia.gene.list')
hxg <- as.character(hxg$gene)
hx.itsc <- intersect(hxg, deg)
length(hx.itsc)

hx.brains.df <- brains.df[which(brains.df$symbol %in% hx.itsc),]
hx.brains.df
```

HIF-1:

- ANKRD37
- PFKFB3
- FECH (different direction)
- GPRC5A
- VEGFA

---

### GWAS genes

Genes associated with the following traits retrieved from GWAS catalog

- stroke
- brain infarction (0 count)
- brain aneurysm
- hypertension
- chronic obstructive pulmonary disease (COPD)
- crohn's disease
- kidney diseases
- coronary artery disease
- coronary heart disease
- autoimmune disease

```{R, eval=F}
access.list <- function(file.df) {
  all <- c()
  for (i in 1:nrow(file.df)) {
    tmp <- file.df$V1[i]
    all <- c(all, strsplit(as.character(tmp), ", ")[[1]])
    all <- unique(all)
  }
  all <- all[!all %in% c('Intergenic', 'intergenic', 'NR')]
}

# stroke
stroke.gene <- read.delim('~/cvd/v6/gwas/stroke.gene.txt', header=F)
stroke <- access.list(stroke.gene)
write.table(all, '~/cvd/v6/gwas/stroke.list', col.names = F, row.names = F, quote = F)
file.remove('~/cvd/v6/gwas/stroke.gene.txt')

# aneurysm
aneurysm.df <- read.delim('~/cvd/v6/gwas/aneurysm.txt', header=F)
aneurysm <- access.list(aneurysm.df)
write.table(aneurysm, '~/cvd/v6/gwas/aneurysm.list', col.names = F, row.names = F, quote = F)
file.remove('~/cvd/v6/gwas/aneurysm.txt')
```


#### Comparasion
```{R}
brain.id <- as.character(brains.df[brains.df$fisherQ < 0.1,]$ID)
stroke.id <- read.delim('~/cvd/v6/gwas/stroke.list', header=F)
stroke.id <- as.character(stroke.id$V1)

aneu.id <- read.delim('~/cvd/v6/gwas/aneurysm.list', header=F)
aneu.id <- as.character(aneu.id$V1)

lapply(all.de, function(x) intersect(x, stroke.id))
lapply(all.de, function(x) intersect(x, aneu.id))
```

### Jitter plot

```{R, fig.width=12, fig.height=7}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(ggpubr)
  library(ggbeeswarm)
  library(Biobase)
})

# load expression file
load("~/cvd/v6/data/filted.cevd.rdata")
exprs <- exprs(filtedSet)
pdata <- pData(filtedSet)
anno <- fData(filtedSet)

brain.jitter <- function(exprs, brains.df, pdata, esid, tissues) {
  t_pdata <- pdata %>% select("SAMPID", "our_subtypes", "MHCVD") %>% filter(our_subtypes %in% tissues)
  exp_list <- as.data.frame(exprs[esid, which(colnames(exprs) %in% t_pdata$SAMPID)])
  exp_list$SAMPID <- rownames(exp_list)
  colnames(exp_list) <- c("counts", "SAMPID")
  mdf <- merge(exp_list, t_pdata, by="SAMPID")
  mdf$MHCVD <- factor(mdf$MHCVD)
  symbol <- as.character(brains.df[brains.df$ESID==esid, ]$symbol)
  q_val <- brains.df[brains.df$ESID==esid, ]$combined.adj.p
  
  # all in one plot
  p1 <- ggplot(data=mdf, aes(x=MHCVD, y=counts, color=MHCVD)) +
          geom_boxplot(size=0.7) + stat_boxplot(geom ='errorbar', size=0.7) +
          geom_quasirandom(size=1, alpha = .4) +
          labs(x="", y="", title=symbol) + scale_color_manual(values = c("#2fc6bc", "#ffa633")) +
          theme_classic() + rremove('legend')
  
  # separated
  p2 <- ggplot(data=mdf, aes(x=our_subtypes, y=counts, color=MHCVD)) + 
          geom_boxplot(size=0.7) + stat_boxplot(geom ='errorbar', size=0.7) +
          geom_quasirandom(dodge.width = .8, size = 0.9, alpha = .6) +
          labs(x="", y="", title=paste0("combined q-val=", formatC(q_val, format="e", digits=2))) + 
          scale_color_manual(values = c("#2fc6bc", "#ffa633")) +
          theme_classic() + rremove('legend')
          #stat_compare_means()
  
  p <- ggarrange(p1, p2, ncol=2, nrow=1, widths=c(2.6,6)) 
}


tissues <- c('brain-0', 'brain-1', 'brain-2')
genes <- c('ANKRD37', 'RBM3', 'RP11-284F21.9', 'SERPINA1')

for (g in 1:length(genes)) {
  esid <- as.character(brains.df[brains.df$symbol==genes[g],]$ESID)
  assign(paste0('p', g) ,brain.jitter(exprs, brains.df, pdata, esid, tissues))
}

ggarrange(p1, p2, p3, p4, ncol=2, nrow=2, common.legend = T, legend='right', labels = c("A", "B", "C", "D"))
```


### DEG in one tissue
```{R, fig.width=3.5, fig.height=3.5}
single.jitter <- function(exprs, pdata, ttable, esid, tissue) {
  t_pdata <- pdata %>% filter(our_subtypes == tissue) %>% select("SAMPID", "MHCVD") 
  exp_list <- as.data.frame(exprs[esid, which(colnames(exprs) %in% t_pdata$SAMPID)])
  exp_list$SAMPID <- rownames(exp_list)
  colnames(exp_list) <- c("counts", "SAMPID")
  mdf <- merge(exp_list, t_pdata, by="SAMPID")
  mdf$MHCVD <- factor(mdf$MHCVD)
  symbol <- as.character(ttable[esid, ]$ID)
  q_val <- ttable[esid, ]$adj.P.Val
  
  ggboxplot(mdf, x="MHCVD", y="counts",
           color="MHCVD", palette="jco", main=paste0(symbol, "  q-val = ", formatC(q_val, format="e", digits=2)),
           xlab=tissue, ylab="qsmooth counts", add="jitter", ggtheme = theme_bw())
  
  ggplot(data=mdf, aes(x=MHCVD, y=counts, color=MHCVD)) +
        geom_boxplot(size=0.5) + stat_boxplot(geom ='errorbar', size=0.5) +
        geom_quasirandom(size=1.1, alpha = 1) +
        labs(x="", y="", title=paste0(symbol, "  adj. p-val=", formatC(q_val, format="e", digits=2))) + 
        scale_color_manual(values = c("#2fc6bc", "#ffa633")) +
        theme_classic()
}

ttable <- all.de[["adipose_visceral_(omentum)"]]
tissue <- "adipose_visceral_(omentum)"
esid <- rownames(ttable[ttable$ID=='ALDH2',])
single.jitter(exprs, pdata, ttable, esid, tissue)
```
