---
title: "Cohort Demography"
author: "Chi-Lam Poon"
date: "9/12/2019"
output: html_document
---


```{R setup, include=T}
suppressPackageStartupMessages({
  library(purrr)
  library(dplyr)
  library(knitr)
  library(ggplot2)
  library(ggpubr)
  library(Biobase)
})
```


#### Load the Rdata filted before
```{R}
main_dir <- "/home/pclam/cvd/v6"
eset <- load(file.path(main_dir, "data/filted.cevd.rdata"))
```


### Demography
##### MHCVD 0 & 1 in each tissue
There are total 6295 samples in the filted dataset, among these 523 had cerebrovascular disease histories (MHCVD = 1) while 5772 didn't (MHCVD = 0).

```{R, fig.height=10, fig.width=10}
pdata <- pData(filtedSet)
pdata$MHCVD <- as.factor(pdata$MHCVD)
m_count1 <- pdata %>% group_by(MHCVD) %>% summarise(counts = n())
m_count1$MHCVD <- as.factor(m_count1$MHCVD)
m_count2 <- pdata %>% group_by(our_subtypes, MHCVD) %>% summarise(counts = n())
m_count2$MHCVD <- as.factor(m_count2$MHCVD)
m_count2$our_subtypes <- as.factor(gsub("_", " ", m_count2$our_subtypes))

# replace long names
m_count2$our_subtypes <- gsub('adipose visceral \\(omentum\\)', 'adipose visceral', m_count2$our_subtypes)
m_count2$our_subtypes <- gsub('esophagus gastroesophageal junction', 'gastroesophageal junction', m_count2$our_subtypes)
m_count2$our_subtypes <- gsub('small intestine terminal ileum', 'intestine terminal ileum', m_count2$our_subtypes)

m1 <- ggplot(m_count1, aes(x=MHCVD, y=counts, fill=MHCVD)) + 
  geom_bar(stat = "identity", color="black") + 
  geom_text(aes(label=counts), vjust = -0.1, size = 3) +
  theme_classic() + theme(axis.title.x=element_blank()) + 
  scale_fill_manual(values = c("#1aa398", "#ffb353")) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.line.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  scale_y_continuous(limits=c(0,6000), expand=c(0,0))

m2 <- ggplot(m_count2, aes(x=MHCVD, y=counts, fill=MHCVD)) +
  geom_bar(stat="identity", color="black") + 
  geom_text(aes(label=counts), vjust = -0.1, size = 3) + 
  theme_classic() +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.line.x=element_blank(),
        axis.ticks.x=element_blank()) +
  scale_fill_manual(values = c("#1aa398", "#ffb353")) + 
  scale_y_continuous(limits=c(0,560)) +
  facet_wrap(~our_subtypes,ncol=4) 

ggarrange(m1, m2, ncol=2, nrow=1, widths=c(1,3), common.legend = T, legend = "right")
```


##### Subject information comparison in gender, AGE, RACE and BMI
```{R}
# Total subject number
pdata2 <- pdata %>% select(SUBJID, gender, AGE, RACE, BMI, MHCVD)
rownames(pdata2) <- seq(1, nrow(pdata2))
pdata2 <- unique(pdata2)
nrow(pdata2)
table(pdata2$MHCVD)
```
Total 444 subjects, and 41 subjects with CeVD histories while 387 without.


##### Age
```{R, fig.width=12}
# Function for T-test
calculateT <- function(v1, v2){
  v1 <- as.numeric(v1)
  v2 <- as.numeric(v2)
  Ftest <- var.test(v1, v2, alternative = "two.sided")
  Ttest <- NA
  ifelse(Ftest$p.value <= 0.05, Ttest <- t.test(v1, v2, paired = F, var.equal = F),
    Ttest <- t.test(v1, v2, paired = F, var.equal = T))
  
  Ttest
}

# Mean and standard deviation for ages of non-CeVD subjects
mean(pdata2[pdata2$MHCVD==0, ]$AGE)
sd(pdata2[pdata2$MHCVD==0, ]$AGE)

# Mean and standard deviation for ages of CeVD subjects
mean(pdata2[pdata2$MHCVD==1, ]$AGE)
sd(pdata2[pdata2$MHCVD==1, ]$AGE)

# T-test for ages in two cohorts
t.age <- calculateT(pdata2[pdata2$MHCVD==0, ]$AGE, pdata2[pdata2$MHCVD==1, ]$AGE)
t.age

age_sum <- pdata2 %>%
  select(AGE, MHCVD) %>%
  group_by(MHCVD) %>%
  summarise(mean.age = mean(AGE, na.rm = T))
m_a1 <- ggplot(pdata2, aes(AGE, fill=MHCVD)) +
  geom_histogram(aes(y=..count..), alpha=0.5) +
  geom_vline(data=age_sum, aes(xintercept=mean.age, colour=MHCVD), lty=2, size=1) +
  scale_fill_brewer(palette="Set2") +
  scale_colour_brewer(palette="Set2") +
  scale_y_continuous(labels=scales::comma) +
  ylab("Count") +
  ggtitle(paste0("Age distribution in two cohorts    P-val = ", formatC(t.age$p.value, format="e", digits = 2))) + 
  labs(x="ages") +
  theme_classic() 
m_a2 <- ggplot(pdata2, aes(AGE, fill=MHCVD)) +
  #geom_histogram(aes(y=..density..), alpha=0.5) +
  geom_density(alpha=.2, aes(colour=MHCVD)) +
  geom_vline(data=age_sum, aes(xintercept=mean.age, colour=MHCVD), lty=2, size=0.6) +
  scale_fill_brewer(palette="Set2") +
  scale_colour_brewer(palette="Set2") +
  scale_y_continuous(labels=scales::percent) +
  ylab("Density") +
  ggtitle("") + 
  labs(x="ages") +
  theme_classic() +
  theme(axis.text.y=element_blank())
ggarrange(m_a1, m_a2, ncol=2, nrow=1, common.legend = T, legend = "right")
```


##### BMI
```{R, fig.width=12}
# Mean and standard deviation for BMIs of non-CeVD subjects
mean(pdata2[pdata2$MHCVD==0, ]$BMI)
sd(pdata2[pdata2$MHCVD==0, ]$BMI)

# Mean and standard deviation for BMIs of CeVD subjects
mean(pdata2[pdata2$MHCVD==1, ]$BMI)
sd(pdata2[pdata2$MHCVD==1, ]$BMI)

# T-test for BMI in two cohorts
t.bmi <- calculateT(pdata2[pdata2$MHCVD==0, ]$BMI, pdata2[pdata2$MHCVD==1, ]$BMI)
t.bmi

bmi_sum <- pdata2 %>%
  select(BMI, MHCVD) %>%
  group_by(MHCVD) %>%
  summarise(mean.bmi = mean(BMI, na.rm = T))
b_a1 <- ggplot(pdata2, aes(BMI, fill=MHCVD)) +
  geom_histogram(aes(y=..count..), alpha=0.5) +
  geom_vline(data=bmi_sum, aes(xintercept=mean.bmi, colour=MHCVD), lty=2, size=1) +
  scale_fill_brewer(palette="Set3") +
  scale_colour_brewer(palette="Set3") +
  scale_y_continuous(labels=scales::comma) +
  ylab("Count") +
  ggtitle(paste0("BMI distribution in two cohorts    P-val = ", round(t.bmi$p.value, 2))) + 
  labs(x="BMI") +
  theme_classic() 
b_a2 <- ggplot(pdata2, aes(BMI, fill=MHCVD)) +
  #geom_histogram(aes(y=..density..), alpha=0.5) +
  geom_density(alpha=.2, aes(colour=MHCVD)) +
  geom_vline(data=bmi_sum, aes(xintercept=mean.bmi, colour=MHCVD), lty=2, size=1) +
  scale_fill_brewer(palette="Set3") +
  scale_colour_brewer(palette="Set3") +
  scale_y_continuous(labels=scales::percent) +
  ylab("Density") +
  ggtitle("") + 
  labs(x="BMI") +
  theme_classic() +
  theme(axis.text.y=element_blank())
ggarrange(b_a1, b_a2, ncol=2, nrow=1, common.legend = T, legend = "right")
```


##### Gender
```{R, fig.width=12}
table(pdata2[pdata2$MHCVD==1, ]$gender)
table(pdata2[pdata2$MHCVD==0, ]$gender)
chi.sex <- chisq.test(rbind(table(pdata2[pdata2$MHCVD==1, ]$gender), table(pdata2[pdata2$MHCVD==0, ]$gender)))
chi.sex

m_g1 <- ggplot(pdata2, aes(gender, fill=MHCVD)) +
  geom_bar(position="stack") +
  scale_fill_brewer(palette="Set1") + 
  scale_y_continuous(labels = scales::comma) +
  ylab("MHCVD") + 
  ggtitle(paste0("MHCVD by Sex    P-val = ", round(chi.sex$p.value, 2))) +
  theme_classic()

m_g2 <- ggplot(pdata2, aes(gender, fill=MHCVD)) +
  geom_bar(position="fill") +
  scale_fill_brewer(palette="Set1") + 
  scale_y_continuous(labels = scales::percent) +
  ylab("MHCVD Rate") + 
  ggtitle("") +
  theme_classic()

ggarrange(m_g1, m_g2, ncol=2, nrow=1, common.legend = T, legend = "right")
```


##### Race
```{R, fig.width=12}
pdata2$RACE <- as.factor(pdata2$RACE)
table(pdata2[pdata2$MHCVD==1, ]$RACE)
table(pdata2[pdata2$MHCVD==0, ]$RACE)
chi.race <- chisq.test(rbind(table(pdata2[pdata2$MHCVD==1, ]$RACE), table(pdata2[pdata2$MHCVD==0, ]$RACE)))
chi.race

m_r1 <- ggplot(pdata2, aes(RACE, fill=MHCVD)) +
  geom_bar(position="stack") +
  scale_fill_brewer(palette="Accent") + 
  scale_x_discrete(labels = c("Asian", "African", "American", "White", "Unknown")) +
  scale_y_continuous(labels = scales::comma) +
  ylab("MHCVD") + 
  ggtitle(paste0("MHCVD by Race    P-val = ", round(chi.race$p.value, 2))) +
  theme_classic() + theme(axis.text.x = element_text(angle = 55, hjust = 1, size = 8.5), 
                          axis.title.x = element_blank())

m_r2 <- ggplot(pdata2, aes(RACE, fill=MHCVD)) +
  geom_bar(position="fill") +
  scale_fill_brewer(palette="Accent") + 
    scale_x_discrete(labels = c("Asian", "African", "American", "White", "Unknown")) +
  scale_y_continuous(labels = scales::percent) +
  ylab("MHCVD Rate") + 
  ggtitle("") +
  theme_classic() + theme(axis.text.x = element_text(angle = 55, hjust = 1, size = 8.5), 
                          axis.title.x = element_blank())

ggarrange(m_r1, m_r2, ncol=2, nrow=1, common.legend = T, legend = "right")
```


##### Tissues in Brian-0,1,2
```{R}
for(i in c("brain-0", "brain-1", "brain-2")){
  brain_sum <- pdata %>% filter(our_subtypes==i) %>%
    select(SAMPID, SMTSD, MHCVD) %>%
    group_by(SMTSD, MHCVD) %>%
    summarise(n = n()) 
  print(kable(brain_sum, caption="tissues in cluster", format="markdown"))
}


chisq.test(c(7,9,9,12,8,10,7,5), c(53,61,85,78,71,69,51,50)) # p-val in brain0
chisq.test(c(12,9), c(76,92)) # p-val in brain1
chisq.test(c(12,9,8), c(86,82,73)) # p-val in brain2
```

